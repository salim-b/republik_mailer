---
title: "Republik Mailer"
author: "Salim BrÃ¼ggemann"
date: "`r Sys.Date()`"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages

```{r, load-packages}
library(magrittr)
```

# Read in configuration

```{r, read-in-config}
if ( file.exists("config.toml") )
{
  config <- RcppTOML::parseTOML(input = "config.toml",
                                escape = FALSE)
} else
{
  config <- list(from = "your.mail@address.suffix",
                 to = "your.mail@address.suffix",
                 salutation = "Ladies and gentleman",
                 greetings = "Einen schÃ¶nen Tag wÃ¼nscht  \nSalims MailBot \U1F916",
                 credits = paste("Dies ist eine automatisch generierte Nachricht.",
                                 "Der zugrundeliegende Code findet sich bei Interesse [hier](https://gitlab.com/salim-b/republik_mailer)."),
                 auth_cookie = "?")
}
```

# Define functions

## Knit `README.Rmd` to `README.md`

```{r, knit-readme}
knit_readme <- function()
{
  knitr::knit2pandoc(input = "README.Rmd",
                     output = "README.md",
                     tangle = FALSE,
                     encoding = "UTF-8",
                     to = "gfm")
  
  if ( file.exists("README.gfm") ) unlink("README.gfm")
}
```

## Get latest articles from specific Republik format

The code below fetches the link, title and lead of the latest articles from a specific article `format`, like [Am Gericht](https://www.republik.ch/format/am-gericht) for example. You have to provide the value of the `connect.sid` cookie, either as argument `auth_cookie` or in a file `.auth_cookie` in the working directory.

Note that the [cURL](https://curl.haxx.se/) command line tool must be available on the system.

```{r, get-latest-article-metadata}
get_latest_article_metadata <- function(format = "am-gericht",
                                        auth_cookie = config$auth_cookie)
{
  # COMMENTED OUT because auth doesn't work with httr::GET (why not?)
  # response <- httr::GET(url = glue::glue("https://www.republik.ch/format/{format}"),
  #                       httr::set_cookies(`connect.sid` = auth_cookie))
  #
  # alternative method to set cookies for httr (doesn't work either!)
  # httr::config(cookie = glue::glue("connect.sid={auth_cookie}"))
  #
  # test if authentication was successful
  # response %>%
  #   httr::content(as = "text") %>%
  #   stringr::str_detect(pattern = "Sie brauchen eine Mitgliedschaft, um die BeitrÃ¤ge zu lesen.",
  #                       negate = TRUE)
  
  # get HTML and extract relevant parts
  article_divs <-
    rlang::with_handlers(error = ~ rlang::abort(message = "Can't fetch content from <republik.ch>!",
                                                parent = .),
                         system2(command = "curl",
                                 args = glue::glue("-v --cookie 'connect.sid={auth_cookie}' https://www.republik.ch/format/{format}"),
                                 stdout = TRUE,
                                 stderr = TRUE)) %>%
    stringr::str_subset(pattern = "<body") %>%
    xml2::read_html() %>%
    # extract all <div> nodes that directly contain a <h1> node
    rvest::html_nodes(xpath = "//div[h1]")
  
  # ensure we actually got something
  if ( length(article_divs) == 0 )
  {
    stop("No articles could be scraped! Maybe your `auth_cookie` is invalid?",
         call. = FALSE)
  }
  
  # extract article links and titles
  articles <-
    tibble::tibble(format =
                     format,
                   href =
                     article_divs %>%
                     rvest::html_node(css = "h1") %>%
                     rvest::html_node(css = "a") %>%
                     rvest::html_attr(name = "href"),
                   title =
                     article_divs %>%
                     rvest::html_node(css = "h1") %>%
                     rvest::html_text())
  
  # add article leads
  articles %<>%
    dplyr::mutate(lead =
                    glue::glue("//a[@href='{articles$href}']") %>%
                    purrr::map(~ rvest::html_nodes(x = article_divs,
                                                   xpath = .x)) %>%
                    purrr::map(~ .x[2]) %>%
                    purrr::map(.f = rvest::html_text) %>%
                    purrr::flatten_chr())
  
  # make links absolute
  articles$href %<>% paste0("https://www.republik.ch", .)
  
  return(articles)
}
```

## Update local article metadata

```{r, update-local-article-metadata}
update_article_metadata <- function(formats = c("am-gericht",
                                                "briefing-aus-bern"))
{
  # read in existing local metadata
  if ( file.exists("article_metadata.rds") )
  {
    article_metadata <<- readRDS(file = "article_metadata.rds")
    
  } else
  {
    article_metadata <<- tibble::tibble(format = character(0),
                                        href = character(0),
                                        title = character(0),
                                        lead = character(0),
                                        is_mailed = logical(0))
  }
  
  # update metadata
  article_metadata <<-
    formats %>%
    purrr::map_dfr(.f = get_latest_article_metadata) %>%
    dplyr::full_join(y = article_metadata,
                     by = colnames(.) %>% setdiff("is_mailed")) %>%
    tidyr::replace_na(replace = list(is_mailed = FALSE)) %>%
    # remove possible duplicates (keep latest metadata)
    dplyr::arrange(-dplyr::row_number()) %>%
    dplyr::filter(!duplicated(href))
  
  saveRDS(object = article_metadata,
          file = "article_metadata.rds")
}
```

## Get new articles' `href`s

```{r, get-new-href}
get_new_hrefs <- function(format)
{
  article_metadata %>%
    dplyr::filter(format == !!format
                  & !is_mailed) %>%
    dplyr::arrange(href) %$%
    href
}
```

## Compose new articles

```{r, compose-new-articles}
compose_new_articles <- function(hrefs)
{
  article_metadata %>%
    dplyr::filter(href %in% hrefs) %>%
    dplyr::arrange(href) %$%
    glue::glue("[**{title}**]({href})  \n{lead}")
}
```

## Set `is_mailed`

```{r, set-mailed}
set_mailed <- function(mailed_hrefs)
{
  article_metadata <<-
    article_metadata %>%
    dplyr::mutate(is_mailed = dplyr::if_else(href %in% mailed_hrefs,
                                             TRUE,
                                             is_mailed))
  
  saveRDS(object = article_metadata,
          file = "article_metadata.rds")
}
```

## Insert CSS into blastula e-mail

```{r, insert-css-into-blastula}
insert_css_into_blastula <- function(blastula_email,
                                     css = "div.footer a {\n      color: #999999;\n    }")
{
  blastula_email$html_str %<>% stringr::str_replace(pattern = "(\\n +)(</style>)",
                                                    replacement = glue::glue("\\1{css}\\1\\2"))
  
  attrs <- attributes(blastula_email$html_html)
  blastula_email$html_html <- blastula_email$html_str
  attributes(blastula_email$html_html) <- attrs
  
  return(blastula_email)
}
```

## Minify HTML

These are simple wrapper functions around the CLI tool [minify](https://github.com/tdewolff/minify). Use parameter `command` to specify where its executable is found on your system (just use `command = "minify"` if it's in the system's `$PATH`).

```{r, minify-html}
minify_html <- function(html,
                        command = "minify")
{
  rlang::with_handlers(error = ~ rlang::abort(message = "HTML minification failed!",
                                              parent = .),
                       system2(command = fs::path_expand(command),
                               input = html,
                               args = "--type=html",
                               stdout = TRUE,
                               stderr = TRUE))
}
```

```{r, minify-html-file}
minify_html_file <- function(filepath,
                             command = "minify")
{
  filepath %>%
    fs::path_abs() %>%
    shQuote(type = "sh") %>%
    rep(times = 2) %>%
    paste0(collapse = " ") %>%
    paste("-o", .) %>%
    system2(command = fs::path_expand(command),
            args = .)
}
```

## Send E-Mail

This is a temporary replacement for `blastula::smtp_send()` until [issue #55](https://github.com/rich-iannone/blastula/issues/55) is fixed.

To set up [mailsend-go](https://github.com/muquit/mailsend-go/) on [RStudio Cloud](https://rstudio.cloud/), use:

```r
download.file(url = "https://github.com/muquit/mailsend-go/releases/download/v1.0.4/mailsend-go_1.0.4_linux-64bit.tar.gz",
              destfile = "m.tar.gz")
untar("m.tar.gz")
unlink("m.tar.gz)
```

Then use `send_mail(mailsend_cmd = "mailsend-go-dir/mailsend-go")`.

```{r, send-mail}
send_mail <- function(html_message = "message.html",
                      subject,
                      to,
                      from,
                      creds_file,
                      mailsend_cmd = "mailsend-go",
                      del_html_message = TRUE)
{
  creds <- readRDS(file = creds_file)
  
  system2(command = mailsend_cmd,
          args = glue::glue(stringr::str_squish(
           "-sub '{subject}' 
            -smtp 'smtp.uzh.ch' 
            -port {creds['port']} 
            auth 
            -user '{creds['user']}' 
            -pass '{creds['password']}' 
            -fname '{creds['sender']}' 
            -from '{from}' 
            -to '{to}' 
            body 
            -file '{html_message}'")))
  
  if ( del_html_message ) unlink(x = html_message)
}
```

## Spread new articles

**Remarks:**

- Currently the package [blastula](https://rich-iannone.github.io/blastula/) used to send e-mails is undergoing heavy changes, i.a. the underlying program used for SMTP [is being replaced](https://rich-iannone.github.io/blastula/articles/sending_using_smtp.html#sending-email) by [mailsend-go](https://github.com/muquit/mailsend-go). Therefore you should use the development version installed directly from GitHub using:

    ```r
    remotes::install_github("rich-iannone/blastula")
    ```

- Beforehand you should [install mailsend-go](https://rich-iannone.github.io/blastula/articles/sending_using_smtp.html#installation-of-mailsend-go). On Ubuntu Linux you also have to install the Debian package `libsodium-dev` which is required by the R package `sodium`, which in turn is a dependency of the R package `keyring`, which is finally a dependency of the `blastula` R package.

- It's recommended to create a file `.mail_credentials` containing the necessary authentication and connection information. You can create it using `blastula::create_email_creds_file()` like the following:

    ```r
    blastula::create_email_creds_file(user = "******@address.suffix",
                                      password = "******",
                                      host = "smtp.address.suffix",
                                      port = 587L,
                                      sender = "Your Name (\U1F916)",
                                      use_ssl = FALSE,
                                      use_tls = TRUE,
                                      authenticate = TRUE,
                                      creds_file_name = ".mail_credentials")
    ```

```{r, spread-new-articles}
spread_new_articles <- function(format,
                                subject,
                                intro,
                                greetings = config$greetings,
                                image_url = NULL,
                                footer = config$credits,
                                latest_one_only = FALSE)
{
  # get hyperlinks of unmailed articles of desired format
  new_hrefs <-
    get_new_hrefs(format = format) %>%
    purrr::when(latest_one_only ~ dplyr::last(.),
                ~ .)
  
  if ( length(new_hrefs) > 0 )
  {
    # compose mail
    blastula::compose_email(
      body = paste0(
        "{config$salutation}\n\n{intro}\n\n",
        paste(compose_new_articles(hrefs = new_hrefs), collapse = "\n\n"),
        dplyr::if_else(!is.null(image_url),
                       glue::glue("\n\n![Symbolbild]({image_url})"),
                       ""),
        "\n\n", greetings),
      footer = footer) %>%
      insert_css_into_blastula() %$%
      html_str %>%
      minify_html() %>%
      readr::write_file(path = "message.html")
    
    # send mail
    send_mail(html_message = "message.html",
              from = config$from,
              to = config$to,
              subject = subject,
              creds_file = ".mail_credentials")
  }
}
```

### Am Gericht

```{r, mail-articles-am-gericht}
mail_am_gericht <- function()
{
  spread_new_articles(format = "am-gericht",
                      subject = "\U2696\UFE0F Republik am Gericht",
                      intro = "Die Republik war wieder [am Gericht](https://www.republik.ch/format/am-gericht):",
                      image_url = paste0("https://cdn.republik.space/s3/republik-assets/github/republik/",
                                         "format-am-gericht/images/ab46b8bfb396500f80893b333aece0419aa536ac.png?resize=516x"))
}
```

### Briefing aus Bern (only on Thursdays)

```{r, mail-articles-briefing-aus-bern}
mail_briefing_aus_bern <- function()
{
  if ( Sys.Date() %>%
       lubridate::wday(week_start = 1) %>%
       magrittr::equals(4) )
  {
    # define random image choices
    images <- tibble::tibble(
      url = c("https://gitlab.com/salim-b/republik_mailer/raw/master/images/storm-brewing-over-the-parliament-516.jpg",
              "https://gitlab.com/salim-b/republik_mailer/raw/master/images/bundesplatz-516.jpg",
              "https://gitlab.com/salim-b/republik_mailer/raw/master/images/bundeshaus-516.jpg",
              "https://gitlab.com/salim-b/republik_mailer/raw/master/images/bundeshaus2-516.jpg",
              "https://gitlab.com/salim-b/republik_mailer/raw/master/images/water-fountain-516.jpg",
              "https://gitlab.com/salim-b/republik_mailer/raw/master/images/museumsnacht-bundeplatz-stereographic-516.jpg",
              "https://gitlab.com/salim-b/republik_mailer/raw/master/images/bern-bundesplatz-516.jpg"),
      credits = c(
        paste0(
          "_[Storm brewing over the Parliament](https://www.flickr.com/photos/chreegou/42317245170/)_ von Christian Scheidegger ist lizenziert unter ",
          "[CC-BY-SA 2.0](https://creativecommons.org/licenses/by-sa/2.0/)"),
        paste0(
          "_[Bundesplatz](https://www.flickr.com/photos/schoeband/6514744179/)_ von Andreina Schoeberlein ist lizenziert unter ",
          "[CC-BY-NC-ND 2.0](https://creativecommons.org/licenses/by-nc-nd/2.0/)"),
        paste0(
          "_[Bundeshaus](https://www.flickr.com/photos/twicepix/4450441204/)_ von Martin Abegglen ist lizenziert unter ",
          "[CC-BY-SA 2.0](https://creativecommons.org/licenses/by-sa/2.0/)"),
        paste0(
          "_[Bundeshaus](https://www.flickr.com/photos/twicepix/4875386468/)_ von Martin Abegglen ist lizenziert unter ",
          "[CC-BY-SA 2.0](https://creativecommons.org/licenses/by-sa/2.0/)"),
        paste0(
          "_[Water Fountain](https://www.flickr.com/photos/glodjib/7371568978/)_ von Guido Gloor Modjib ist lizenziert unter ",
          "[CC-BY-NC-ND 2.0](https://creativecommons.org/licenses/by-nc-nd/2.0/)"),
        paste0(
          "_[Museumsnacht Bundeplatz Stereographic](https://www.flickr.com/photos/habi/5546211688/)_ von David HaberthÃ¼r ist lizenziert unter ",
          "[CC-BY-NC 2.0](https://creativecommons.org/licenses/by-nc/2.0/)"),
        paste0(
          "_[Bern Bundesplatz](https://www.flickr.com/photos/codeseven/3798802986/)_ von Philipp ist lizenziert unter ",
          "[CC-BY-NC-ND 2.0](https://creativecommons.org/licenses/by-nc-nd/2.0/)"))
    )
    
    # choose an image randomly
    random_image_choice <-
      runif(n = 1,
            min = 1,
            max = nrow(images)) %>%
      round(digits = 0)
    
    # spread article
    spread_new_articles(format = "briefing-aus-bern",
                        subject = "\U1F1E8\U1F1ED Republik-Briefing aus Bern",
                        intro = paste("Das heutige [Briefing aus Bern](https://www.republik.ch/format/briefing-aus-bern) der Republik fasst",
                                      "_Â«das Wichtigste in KÃ¼rze aus Parlament, Regierung und Verwaltung, kurz: dem BundeshausÂ»_",
                                      "der letzten 7 Tage zusammen:"),
                        image_url = images$url[random_image_choice],
                        footer = paste0("{images$credits[random_image_choice]}\n\n",
                                        config$credits),
                        latest_one_only = TRUE)
  }
}
```

### Loop

This is a very basic loop function intended to run the functions to spread new articles for an indefinite amount of time. Probably not what you want! ðŸ˜‰

```{r, loop}
loop <- function()
{
  while( TRUE )
  {
    # sleep until 6 in the morning
    lubridate::as_datetime(x = paste(Sys.Date() + ifelse(lubridate::hour(lubridate::as_datetime(Sys.time(),
                                                                                                tz = "Europe/Zurich")) < 6L,
                                                         0L,
                                                         1L),
                                     "06:00:00"),
                           tz = "Europe/Zurich") %>%
      magrittr::subtract(lubridate::as_datetime(x = Sys.time(),
                                                tz = "Europe/Zurich")) %>%
      hms::as.hms() %>%
      as.integer() %>%
      Sys.sleep()
    
    # then do your duty
    update_article_metadata()
    mail_briefing_aus_bern()
    mail_am_gericht()
  }
}
```
