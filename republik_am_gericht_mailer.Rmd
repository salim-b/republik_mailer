---
title: "«Republik am Gericht» Mailer"
author: "Salim Brüggemann"
date: "`r Sys.Date()`"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Requirements

First of all: This script doesn't allow any unauthenticated access to the online newspaper [Republik](https://www.republik.ch/)! You have to be a (paying) subscriber. This allows you to [log in to the site](https://www.republik.ch/anmelden) which results in the creation of a session cookie needed for authentication. This cookie is named `connect.sid`  and you need to provide its content[^view-cookie] (a cryptographic hash) as the `auth_cookie` argument to the function `get_latest_articles()`.


[^view-cookie]: How you access the locally stored cookies of a specific site in Google Chrome is described [here](https://developers.google.com/web/tools/chrome-devtools/storage/cookies), the same for Firefox [here](https://developer.mozilla.org/docs/Tools/Storage_Inspector). The cookie's content can also be stored in a text file named `.auth_cookie` in the same folder as this script.


# Define functions

## Get latest articles from specific Republik format

The code below fetches the link, title and lead of the latest articles from a specific article `format`, like [Am Gericht](https://www.republik.ch/format/am-gericht) for example.

```{r, get-latest-article-metadata}
get_latest_article_metadata <- function(format = "am-gericht",
                                        auth_cookie = NULL)
{
  # read in auth cookie from file
  if ( is.null(auth_cookie) )
  {
    if ( file.exists(".auth_cookie") )
    {
      auth_cookie <- readr::read_lines(file = ".auth_cookie",
                                       skip_empty_rows = TRUE,
                                       n_max = 1)
    } else
    {
      stop("No `auth_cookie` argument provided and no `.auth_cookie` file found either!")
    }
  }
  
  # COMMENTED OUT because auth doesn't work with httr::GET (why not?)
  # response <- httr::GET(url = glue::glue("https://www.republik.ch/format/{format}"),
  #                       httr::set_cookies(`connect.sid` = auth_cookie))
  #
  # alternative method to set cookies for httr (doesn't work either!)
  # httr::config(cookie = glue::glue("connect.sid={auth_cookie}"))
  #
  # test if authentication was successful
  # response %>%
  #   httr::content(as = "text") %>%
  #   stringr::str_detect(pattern = "Sie brauchen eine Mitgliedschaft, um die Beiträge zu lesen.",
  #                       negate = TRUE)
  
  article_divs <-
    system2(command = "curl",
            args = glue::glue("-v --cookie 'connect.sid={auth_cookie}' https://www.republik.ch/format/{format}"),
            stdout = TRUE,
            stderr = TRUE) %>%
    stringr::str_subset(pattern = "<body") %>%
    xml2::read_html() %>%
    # extract all <div> nodes that directly contain a <h1> node
    rvest::html_nodes(xpath = "//div[h1]")
  
  # ensure we actually got something
  if ( length(article_divs) == 0 )
  {
    stop("No articles could be scraped! Maybe your `auth_cookie` is invalid?",
         call. = FALSE)
  }
  
  # extract article links and titles
  articles <-
    tibble::tibble(format =
                     format,
                   href =
                     article_divs %>%
                     rvest::html_node(css = "h1") %>%
                     rvest::html_node(css = "a") %>%
                     rvest::html_attr(name = "href"),
                   title =
                     article_divs %>%
                     rvest::html_node(css = "h1") %>%
                     rvest::html_text())
  
  # add article leads
  articles %<>%
    dplyr::mutate(lead =
                    glue::glue("//a[@href='{articles$href}']") %>%
                    purrr::map(~ rvest::html_nodes(x = article_divs,
                                                   xpath = .x)) %>%
                    purrr::map(~ .x[2]) %>%
                    purrr::map(.f = rvest::html_text) %>%
                    purrr::flatten_chr())
  
  # make links absolute
  articles$href %<>% paste0("https://www.republik.ch", .)
  
  return(articles)
}
```

## Insert CSS into blastula e-mail

```{r, insert-css-into-blastula}
insert_css_into_blastula <- function(blastula_email,
                                     css = "div.footer a {\n      color: #999999;\n    }")
{
  blastula_email$html_str %<>% stringr::str_replace(pattern = "(\\n +)(</style>)",
                                                    replacement = glue::glue("\\1{css}\\1\\2"))
  
  attrs <- attributes(blastula_email$html_html)
  blastula_email$html_html <- blastula_email$html_str
  attributes(blastula_email$html_html) <- attrs
  
  return(blastula_email)
}
```

# Update local article metadata

```{r, store-article-metadata-locally}
# read in existing local metadata
if ( file.exists("article_metadata.rds") )
{
  article_metadata <- readRDS(file = "article_metadata.rds")
  
} else
{
  article_metadata <- tibble::tibble(format = character(0),
                                     href = character(0),
                                     title = character(0),
                                     lead = character(0),
                                     is_mailed = logical(0))
}

# update metadata
article_metadata %<>%
  dplyr::full_join(y = get_latest_article_metadata(format = "am-gericht"),
                   by = colnames(.) %>% setdiff("is_mailed")) %>%
  dplyr::full_join(y = get_latest_article_metadata(format = "briefing-aus-bern"),
                   by = colnames(.) %>% setdiff("is_mailed")) %>%
  tidyr::replace_na(replace = list(is_mailed = FALSE))

saveRDS(object = article_metadata,
        file = "article_metadata.rds")
```

# Send E-Mail with new articles

```{r, mail-articles}
# Am Gericht
if ( article_metadata %>%
     dplyr::filter(format == "am-gericht") %$%
     is_mailed %>%
     isFALSE() %>%
     any() )
{
  new_articles <-
    article_metadata %>%
    dplyr::filter(format == "am-gericht"
                  & !is_mailed) %>%
    dplyr::mutate(md = glue::glue("[**{title}**]({href})  \n{lead}")) %$%
    md
  
  new_mail <- blastula::compose_email(
    body = paste0(
      "Liebes C2D-Team,\n\nDie Republik war wieder [am Gericht](https://www.republik.ch/format/am-gericht):\n\n",
      paste(new_articles, collapse = "\n\n"),
      "\n\n![Symbolbild]",
      "(https://cdn.republik.space/s3/republik-assets/github/republik/format-am-gericht/images/ab46b8bfb396500f80893b333aece0419aa536ac.png?resize=516x)"),
    footer = paste0(
      "Dies ist eine automatisch generierte Nachricht. Der zugrundeliegende Code findet sich bei Interesse ",
      "[hier](https://gitlab.com/salim-b/republik_mailer)."))
}

# Briefing aus Bern (only on Thursdays)
if ( (article_metadata %>%
      dplyr::filter(format == "briefing-aus-bern") %$%
      is_mailed %>%
      isFALSE() %>%
      any()) &
     (Sys.Date() %>%
      lubridate::wday() %>%
      magrittr::equals(5)) )
{
  new_articles <-
    article_metadata %>%
    dplyr::filter(format == "briefing-aus-bern"
                  & !is_mailed) %>%
    dplyr::mutate(md = glue::glue("[**{title}**]({href})  \n{lead}")) %$%
    md
  
  images <- tibble::tibble(
    url = c(""),
    credits = c(
      paste0(
        "_Storm brewing over the Parliament_ von Christian Scheidegger ist lizenziert unter ",
        "[CC-BY-NC 2.0](https://creativecommons.org/licenses/by-nc/2.0/)"),
      paste0(
        "_Bundesplatz_ von Andreina Schoeberlein ist lizenziert unter ",
        "[CC-BY-NC 2.0](https://creativecommons.org/licenses/by-nc/2.0/)"))
  )
  
  new_mail <- blastula::compose_email(
    body = paste0(
      "Liebes C2D-Team,\n\nDas heutige [Briefing aus Bern](https://www.republik.ch/format/briefing-aus-bern) fasst ",
      "_«das Wichtigste in Kürze aus Parlament, Regierung und Verwaltung, kurz: dem Bundeshaus» der letzten 7 Tage zusammen:\n\n",
      paste(new_articles, collapse = "\n\n"),
      "\n\n![Symbolbild]",
      "(https://cdn.republik.space/s3/republik-assets/github/republik/format-am-gericht/images/ab46b8bfb396500f80893b333aece0419aa536ac.png?resize=516x)"),
    footer = paste0(
      images$credits[2], "\n\n",
      "Dies ist eine automatisch generierte Nachricht. Der zugrundeliegende Code findet sich bei Interesse ",
      "[hier](https://gitlab.com/salim-b/republik_mailer)."))
}
```
